<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI इमेज जनरेटर (अंतिम स्थिर वर्जन)</title>
    <!-- Tailwind CSS (Simplest inclusion) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .container-card {
            background-color: #1e293b;
            border: 1px solid #334155;
        }
        .btn-primary {
            background-color: #3b82f6;
            transition: background-color 0.2s;
        }
        .loading-spinner {
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Aspect Ratio Display Control */
        .aspect-ratio-box-1-1 { aspect-ratio: 1/1; }
        .aspect-ratio-box-16-9 { aspect-ratio: 16/9; }
        .aspect-ratio-box-9-16 { aspect-ratio: 9/16; }
        .aspect-ratio-box-3-4 { aspect-ratio: 3/4; }
    </style>
</head>
<body>

    <div class="min-h-screen p-4 flex justify-center items-start">
        <div class="w-full max-w-5xl my-8">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">AI इमेज जनरेटर</h1>
            <p class="text-center text-slate-400 mb-8">रेफ़रेंस इमेज और विस्तृत प्रॉम्प्ट (पोज़/इमोशन सहित) का उपयोग करें।</p>

            <div id="app-container" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- इनपुट पैनल -->
                <div class="lg:col-span-1 container-card p-6 rounded-xl shadow-2xl space-y-6">
                    
                    <!-- 1. इमेज अपलोड -->
                    <div>
                        <label class="block text-sm font-semibold mb-2">1. रेफ़रेंस इमेज अपलोड करें:</label>
                        <input type="file" id="imageFile" accept="image/*" class="w-full text-sm text-slate-400 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700" onchange="handleImageUpload(event)">
                        <div id="refImagePreviewContainer" class="mt-4 hidden border border-slate-700 rounded-lg p-2 bg-slate-900">
                            <img id="refImagePreview" class="max-w-full h-auto rounded-md mx-auto" alt="Reference Image Preview">
                        </div>
                    </div>

                    <!-- 2. आस्पेक्ट रेशियो -->
                    <div>
                        <label for="aspectRatio" class="block text-sm font-semibold mb-2">2. आस्पेक्ट रेशियो चुनें:</label>
                        <select id="aspectRatio" class="w-full p-3 rounded-lg bg-slate-900 border border-slate-700 text-white focus:ring-blue-500" onchange="updateOutputAspect()">
                            <option value="1:1">1:1 (Square)</option>
                            <option value="16:9">16:9 (Landscape - चौड़ा)</option>
                            <option value="9:16">9:16 (Portrait - लम्बा)</option>
                            <option value="3:4">3:4 (Portrait - लम्बा)</option>
                        </select>
                    </div>

                    <!-- 3. प्रॉम्प्ट -->
                    <div>
                        <label for="prompt" class="block text-sm font-semibold mb-2">3. टेक्स्ट प्रॉम्प्ट (पोज़/इमोशन) लिखें:</label>
                        <textarea id="prompt" rows="5" placeholder="उदाहरण: एक आदमी (खुशी से मुस्कुराते हुए, अपना हाथ ऊपर उठाते हुए), पानी के भीतर तैर रहा है।" class="w-full p-3 rounded-lg bg-slate-900 border border-slate-700 text-white placeholder-slate-500 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <!-- जनरेट बटन -->
                    <button onclick="generateImage()" id="generateButton" class="w-full btn-primary text-white font-bold py-3 rounded-xl text-lg shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="buttonText">इमेज जनरेट करें</span>
                        <div id="loadingIndicator" class="loading-spinner w-5 h-5 ml-2 border-white border-t-2 rounded-full hidden"></div>
                    </button>
                    
                    <div id="errorMessage" class="text-red-400 text-sm text-center font-medium hidden"></div>

                </div>

                <!-- आउटपुट पैनल -->
                <div class="lg:col-span-2 container-card p-6 rounded-xl shadow-2xl">
                    <h2 class="text-xl font-bold mb-4">जनरेटेड इमेज (Generated Image)</h2>
                    
                    <!-- इमेज डिस्प्ले कंटेनर -->
                    <div id="imageOutputContainer" class="w-full bg-slate-900 rounded-xl flex flex-col items-center justify-center min-h-[300px] border border-dashed border-slate-700 relative p-4 aspect-ratio-box-1-1">
                        <img id="generatedImage" class="max-w-full max-h-full rounded-xl shadow-xl object-contain hidden" alt="Generated Image">
                        <p id="placeholderText" class="text-slate-500 text-center p-8">यहाँ आपकी नई इमेज दिखाई देगी।</p>
                    </div>

                    <!-- Base64 आउटपुट एरिया (डाउनलोड का अंतिम उपाय) -->
                    <div id="base64Container" class="mt-6 hidden">
                         <h3 class="text-md font-semibold mb-2 text-yellow-400">इमेज सेव करने के लिए (Final Solution):</h3>
                        <p class="text-sm text-slate-400 mb-2">नीचे दिए गए कोड को *चुनकर कॉपी* करें, और इसे Base64 डिकोडर टूल में पेस्ट करें।</p>
                        <textarea id="base64CodeOutput" rows="8" readonly class="w-full p-2 rounded-lg bg-slate-900 border border-slate-700 text-xs text-yellow-200 resize-none"></textarea>
                    </div>

                </div>

            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const apiKey = ""; 
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=" + apiKey;

        let referenceImageBase64 = null;

        function updateOutputAspect() {
            const container = document.getElementById('imageOutputContainer');
            const aspectRatio = document.getElementById('aspectRatio').value;

            // Remove all aspect ratio classes
            container.className = container.className.split(' ').filter(c => !c.startsWith('aspect-ratio-box-')).join(' ');

            // Add the selected aspect ratio class
            if (aspectRatio === '1:1') container.classList.add('aspect-ratio-box-1-1');
            else if (aspectRatio === '16:9') container.classList.add('aspect-ratio-box-16-9');
            else if (aspectRatio === '9:16') container.classList.add('aspect-ratio-box-9-16');
            else if (aspectRatio === '3:4') container.classList.add('aspect-ratio-box-3-4');
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('refImagePreview');
            const previewContainer = document.getElementById('refImagePreviewContainer');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    referenceImageBase64 = e.target.result.split(',')[1];
                    preview.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                referenceImageBase64 = null;
                previewContainer.classList.add('hidden');
                preview.src = '';
            }
        }

        async function generateImage() {
            const prompt = document.getElementById('prompt').value.trim();
            const aspectRatio = document.getElementById('aspectRatio').value;
            const errorElement = document.getElementById('errorMessage');
            const imageElement = document.getElementById('generatedImage');
            const placeholderText = document.getElementById('placeholderText');
            const base64Container = document.getElementById('base64Container');
            const base64CodeOutput = document.getElementById('base64CodeOutput');

            errorElement.classList.add('hidden');
            base64Container.classList.add('hidden');
            
            if (!prompt || !referenceImageBase64) {
                errorElement.textContent = "कृपया प्रॉम्प्ट और रेफ़रेंस इमेज दोनों प्रदान करें।";
                errorElement.classList.remove('hidden');
                return;
            }

            // UI Loading State
            document.getElementById('generateButton').disabled = true;
            document.getElementById('buttonText').textContent = "इमेज जनरेट हो रही है...";
            document.getElementById('loadingIndicator').classList.remove('hidden');
            imageElement.classList.add('hidden');
            placeholderText.textContent = "AI आपकी नई इमेज बना रहा है... कृपया प्रतीक्षा करें।";
            placeholderText.classList.remove('hidden');

            // Strong prompt for identity, pose, emotion, and aspect ratio
            const fullPrompt = STRICTLY regenerate the attached image. Maintain the identity (the person or subject) from the reference image, but strictly apply this new request: "${prompt}". You MUST accurately change the pose, emotions, style, and background as requested. IMPORTANT: Adhere to the aspect ratio: ${aspectRatio}. If the content must be cropped or padded to fit the requested aspect ratio, do so.;

            const payload = {
                contents: [{
                    parts: [
                        { text: fullPrompt },
                        { inlineData: { mimeType: "image/png", data: referenceImageBase64 } }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE'],
                },
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(API Error: ${response.status} ${response.statusText});
                }
                
                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (!base64Data) {
                    throw new Error("AI ने कोई इमेज डेटा नहीं भेजा।");
                }

                const imageUrl = data:image/png;base64,${base64Data};
                
                imageElement.src = imageUrl;
                imageElement.classList.remove('hidden');
                placeholderText.classList.add('hidden');

                // Display Base64 Code
                base64CodeOutput.value = base64Data;
                base64Container.classList.remove('hidden');

            } catch (error) {
                console.error("इमेज जनरेशन एरर:", error);
                errorElement.textContent = जनरेशन एरर: ${error.message};
                errorElement.classList.remove('hidden');
                placeholderText.textContent = "इमेज जनरेशन में त्रुटि हुई।";
                placeholderText.classList.remove('hidden');
                imageElement.classList.add('hidden');
                base64Container.classList.add('hidden');
            } finally {
                // UI Reset
                document.getElementById('generateButton').disabled = false;
                document.getElementById('buttonText').textContent = "इमेज जनरेट करें";
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        // Initialize aspect ratio on load
        document.addEventListener('DOMContentLoaded', updateOutputAspect);
    </script>

</body>
</html>
